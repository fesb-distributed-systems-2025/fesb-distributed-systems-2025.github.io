"use strict";(self.webpackChunkdistributed_systems=self.webpackChunkdistributed_systems||[]).push([[296],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},l=Object.keys(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var i=r.createContext({}),p=function(e){var t=r.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=p(e.components);return r.createElement(i.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,l=e.originalType,i=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=p(n),m=a,g=d["".concat(i,".").concat(m)]||d[m]||c[m]||l;return n?r.createElement(g,o(o({ref:t},u),{},{components:n})):r.createElement(g,o({ref:t},u))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var l=n.length,o=new Array(l);o[0]=d;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s.mdxType="string"==typeof e?e:a,o[1]=s;for(var p=2;p<l;p++)o[p]=n[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},7527:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>o,default:()=>c,frontMatter:()=>l,metadata:()=>s,toc:()=>p});var r=n(7462),a=(n(7294),n(3905));const l={},o="Lesson",s={unversionedId:"labs/Lab 10 - Error handling/Lesson",id:"labs/Lab 10 - Error handling/Lesson",title:"Lesson",description:"Table of Contents",source:"@site/docs/labs/10.Lab 10 - Error handling/Lesson.md",sourceDirName:"labs/10.Lab 10 - Error handling",slug:"/labs/Lab 10 - Error handling/Lesson",permalink:"/docs/labs/Lab 10 - Error handling/Lesson",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Homework",permalink:"/docs/labs/Lab 10 - Error handling/Homework"},next:{title:"Lesson",permalink:"/docs/labs/Lab 12 - Docker/Lesson"}},i={},p=[{value:"<strong>Table of Contents</strong>",id:"table-of-contents",level:2},{value:"<strong>Error Handling</strong>",id:"error-handling",level:2},{value:"<strong>Result pattern</strong>",id:"result-pattern",level:3},{value:"<strong>Exceptions logging</strong>",id:"exceptions-logging",level:3}],u={toc:p};function c(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"lesson"},"Lesson"),(0,a.kt)("h1",{id:"lab-10-error-handling"},"Lab 10: Error Handling"),(0,a.kt)("h2",{id:"table-of-contents"},(0,a.kt)("strong",{parentName:"h2"},"Table of Contents")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#lesson"},"Lesson")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#lab-10-error-handling"},"Lab 10: Error Handling"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#table-of-contents"},(0,a.kt)("strong",{parentName:"a"},"Table of Contents"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#error-handling"},(0,a.kt)("strong",{parentName:"a"},"Error Handling")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#result-pattern"},(0,a.kt)("strong",{parentName:"a"},"Result pattern"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#exceptions-logging"},(0,a.kt)("strong",{parentName:"a"},"Exceptions logging")))))))),(0,a.kt)("h2",{id:"error-handling"},(0,a.kt)("strong",{parentName:"h2"},"Error Handling")),(0,a.kt)("p",null,"In a typical Web API request (Controller \u2192 Service \u2192 Repository \u2192 Database), there are two big categories of problems:"),(0,a.kt)("p",null,"1) User / client mistakes (expected problems)"),(0,a.kt)("p",null,"These are situations where the request is valid HTTP, but the business rules say \u201cno\u201d. Examples:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Sender/Receiver doesn\u2019t exist"),(0,a.kt)("li",{parentName:"ul"},"Subject is missing or too long"),(0,a.kt)("li",{parentName:"ul"},"Message is too long\nAny other validation rule you want to enforce")),(0,a.kt)("p",null,"These are not exceptional in the programming sense \u2014 they are normal outcomes you can predict and handle. These cases user can handle if message is enough good explained."),(0,a.kt)("p",null,"Application handles these with Result",(0,a.kt)("inlineCode",{parentName:"p"},"<T>")," and validation lists."),(0,a.kt)("p",null,"2) System / server failures (unexpected problems)"),(0,a.kt)("p",null,"These are situations where something breaks in the system. Examples:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"A bug in code (null reference, etc.)"),(0,a.kt)("li",{parentName:"ul"},"Database connection fails"),(0,a.kt)("li",{parentName:"ul"},"Repository throws KeyNotFoundException\nAny unhandled exception")),(0,a.kt)("p",null,"These are exceptions \u2014 you generally log them and return a safe generic response. These cases handle developers from database logs."),(0,a.kt)("p",null,"Application handles these with ExceptionLoggingMiddleware."),(0,a.kt)("p",null,"So application is separating:"),(0,a.kt)("p",null,"User-caused errors \u2192 controlled response (400, validation messages)"),(0,a.kt)("p",null,"System exceptions \u2192 logged + generic 500 response"),(0,a.kt)("h3",{id:"result-pattern"},(0,a.kt)("strong",{parentName:"h3"},"Result pattern")),(0,a.kt)("p",null,"The Result pattern returning outcomes instead of throwing for validation.\nWhat Result",(0,a.kt)("inlineCode",{parentName:"p"},"<T>")," means?"),(0,a.kt)("p",null,"Result",(0,a.kt)("inlineCode",{parentName:"p"},"<T>")," is a wrapper that says:"),(0,a.kt)("p",null,"IsSuccess == true \u2192 the operation completed successfully"),(0,a.kt)("p",null,"IsSuccess == false \u2192 the operation failed for expected reasons, and we have a list of messages in ErrorItems"),(0,a.kt)("p",null,"So instead of \u201cthrowing\u201d for validation problems, you return:"),(0,a.kt)("p",null,"Result.Failure(",'["Subject is required", "Sender not found"]',")"),(0,a.kt)("p",null,"This is good because:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"validation failures are expected, not \u201ccrashes\u201d"),(0,a.kt)("li",{parentName:"ul"},"the service can gather multiple validation problems at once (not fail on the first one)"),(0,a.kt)("li",{parentName:"ul"},"the controller doesn\u2019t need to know how validation works; it just converts the result to HTTP")),(0,a.kt)("p",null,"ValidationResult is basically a \u201cpre-result\u201d used for validation: IsSuccess is true when there are no messages."),(0,a.kt)("p",null,"ValidationItems collects problems. Then the service converts it to a Result",(0,a.kt)("inlineCode",{parentName:"p"},"<object>"),".Failure(...)."),(0,a.kt)("p",null,"Controller stays clean by using one \u201ctranslator\u201d method."),(0,a.kt)("p",null,"StatusHandler.HandleResult is extension method that is acting like a small \u201ctranslator\u201d from Result",(0,a.kt)("inlineCode",{parentName:"p"},"<T>")," to HTTP:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"If success \u2192 200 OK with value"),(0,a.kt)("li",{parentName:"ul"},"If failure \u2192 400 BadRequest with error items")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},"var result = await _emailService.AddEmail(email);\nreturn this.HandleResult(result);\n")),(0,a.kt)("admonition",{type:"caution"},(0,a.kt)("mdxAdmonitionTitle",{parentName:"admonition"},(0,a.kt)("strong",{parentName:"mdxAdmonitionTitle"},"IMPORTANT")),(0,a.kt)("p",{parentName:"admonition"},"Controller does not do validation.\nController does not do try/catch.\nController just delegates and translates.")),(0,a.kt)("h3",{id:"exceptions-logging"},(0,a.kt)("strong",{parentName:"h3"},"Exceptions logging")),(0,a.kt)("p",null,"Exceptions can be handled and unhandled."),(0,a.kt)("p",null,"Handled exceptions are catched by try-catch blocks and are not loggoed automatically in ExceptionLoggingMiddleware. We need log them manually."),(0,a.kt)("p",null,'Unhandled exceptions can be expected and unexpected. For expected exceptions we make their "throw". That is case that we can expect will happen sometime. Example:'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},'\nif (email == null)\n{\n    throw new KeyNotFoundException($"Cannot find email with Id: {id}");\n}\n\n')),(0,a.kt)("p",null,"This error means we have some bug in application. It can be on frontend or backend. There should't be non-valid IDs in system."),(0,a.kt)("p",null,"For unexpected exceptions is responsible ExceptionLoggingMiddleware. It log all system failures (null reference exception, EF errors, DB errors, ...) into database."),(0,a.kt)("p",null,'ExceptionLoggingMiddleware is the \u201clast safety net\u201d. It wraps the whole pipeline, catches any unhandled exception, logs it (LogError(ex, "Unhandled exception")) and returns 500 with a generic JSON message.'),(0,a.kt)("p",null,"Why the response is generic?"),(0,a.kt)("p",null,"Because exceptions may contain sensitive details:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"database info"),(0,a.kt)("li",{parentName:"ul"},"stack traces"),(0,a.kt)("li",{parentName:"ul"},"internal IDs"),(0,a.kt)("li",{parentName:"ul"},"library versions")),(0,a.kt)("p",null,"So the middleware returns only:"),(0,a.kt)("p",null,'{ "error": "Internal server error" }'),(0,a.kt)("p",null,"But the important part is: the details are still saved in logs, not sent to the user."))}c.isMDXComponent=!0}}]);